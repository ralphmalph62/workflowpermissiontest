name: Handle Translation Command

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write

jobs:
  translate:
    # Only run if the comment is on a PR and contains /translate
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/translate')
    runs-on: ubuntu-latest
    steps:
      - name: Check if commenter is docs-maintainer
        id: check-permission
        run: |
          # Check if the user is a member of the docs-maintainer team
          # Organization: extract from repository (e.g., "owner/repo" -> "owner")
          ORG=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          USER="${{ github.event.comment.user.login }}"
          
          # Check team membership using GitHub API
          response=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /orgs/$ORG/teams/docs-maintainer/memberships/$USER \
            --silent 2>&1 || echo "not_member")
          
          if [[ "$response" == *"not_member"* ]] || [[ "$response" == *"Not Found"* ]]; then
            echo "User $USER is not a member of docs-maintainer team"
            echo "is_maintainer=false" >> $GITHUB_OUTPUT
          else
            echo "User $USER is a member of docs-maintainer team"
            echo "is_maintainer=true" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.DOC_MEMBERSHIP_PAT }}

      - name: Add reaction to comment
        if: steps.check-permission.outputs.is_maintainer == 'true'
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
            -f content='rocket'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR details
        if: steps.check-permission.outputs.is_maintainer == 'true'
        id: pr-details
        run: |
          PR_DATA=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/pulls/${{ github.event.issue.number }})
          
          HEAD_REF=$(echo "$PR_DATA" | jq -r '.head.ref')
          HEAD_SHA=$(echo "$PR_DATA" | jq -r '.head.sha')
          HEAD_REPO=$(echo "$PR_DATA" | jq -r '.head.repo.full_name')
          BASE_SHA=$(echo "$PR_DATA" | jq -r '.base.sha')
          IS_FORK=$(echo "$PR_DATA" | jq -r '.head.repo.fork')
          
          echo "head_ref=$HEAD_REF" >> $GITHUB_OUTPUT
          echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT
          echo "head_repo=$HEAD_REPO" >> $GITHUB_OUTPUT
          echo "base_sha=$BASE_SHA" >> $GITHUB_OUTPUT
          echo "is_fork=$IS_FORK" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout PR branch
        if: steps.check-permission.outputs.is_maintainer == 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.pr-details.outputs.head_repo }}
          ref: ${{ steps.pr-details.outputs.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Get checked translations from comment
        if: steps.check-permission.outputs.is_maintainer == 'true'
        id: get-files
        run: |
          # Fetch all comments on the PR
          gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments" \
            > pr_comments.json
          
          # Find the translation check comment (by github-actions[bot] containing "Missing translations")
          python3 << 'PYTHON_SCRIPT'
          import json
          import re
          
          # Read comments
          with open('pr_comments.json', 'r') as f:
              comments = json.load(f)
          
          # Find the translation check comment
          translation_comment = None
          for comment in comments:
              if (comment['user']['login'] == 'github-actions[bot]' and 
                  'Missing translations detected' in comment['body']):
                  translation_comment = comment['body']
                  break
          
          if not translation_comment:
              print("No translation check comment found")
              exit(0)
          
          # Parse checked boxes from the comment
          # Checkbox format: - [ ] or - [x] followed by file description
          # Example: - [x] **EN → ZH**: `loading/Etl_in_loading.md` *(auto-generated)*
          checked_translations = []
          
          for line in translation_comment.split('\n'):
              # Look for checked boxes: - [x] or - [X]
              if re.match(r'^\s*-\s*\[[xX]\]', line):
                  # Extract the source language, target language, and file path
                  # Pattern: **SOURCE → TARGET**: `file/path.md`
                  match = re.search(r'\*\*(EN|ZH|JA)\s*→\s*(EN|ZH|JA)\*\*:\s*`([^`]+)`', line)
                  if match:
                      source_lang = match.group(1).lower()
                      target_lang = match.group(2).lower()
                      rel_path = match.group(3)
                      
                      # Build the translation entry
                      source_file = f"docs/{source_lang}/{rel_path}"
                      checked_translations.append(f"{source_lang}:{target_lang}:{source_file}")
                      print(f"Found checked: {source_lang} → {target_lang}: {rel_path}")
          
          # Write checked translations to file
          if checked_translations:
              with open('missing_translations.txt', 'w') as f:
                  f.write('\n'.join(checked_translations))
              print(f"\nTotal checked translations: {len(checked_translations)}")
          else:
              print("No checked translations found")
          PYTHON_SCRIPT
          
          if [ -f missing_translations.txt ] && [ -s missing_translations.txt ]; then
            echo "has_files=true" >> $GITHUB_OUTPUT
            echo "Files to translate:"
            cat missing_translations.txt
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
            echo "No translations selected. Please check the boxes in the translation comment for the files you want to translate."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout markdown-translator
        if: steps.check-permission.outputs.is_maintainer == 'true' && steps.get-files.outputs.has_files == 'true'
        uses: actions/checkout@v4
        with:
          repository: 'StarRocks/markdown-translator'
          ref: 'main'
          path: 'markdown-translator'

      - name: Setup Node.js
        if: steps.check-permission.outputs.is_maintainer == 'true' && steps.get-files.outputs.has_files == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install translation dependencies
        if: steps.check-permission.outputs.is_maintainer == 'true' && steps.get-files.outputs.has_files == 'true'
        run: |
          cd markdown-translator
          npm install

      - name: Generate translations
        if: steps.check-permission.outputs.is_maintainer == 'true' && steps.get-files.outputs.has_files == 'true'
        id: translate
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cd "$GITHUB_WORKSPACE"
          
          translation_count=0
          failed_count=0
          
          while IFS= read -r line; do
            # Parse line: source_lang:target_lang:source_file
            IFS=':' read -r source_lang target_lang source_file <<< "$line"
            
            # Derive target file path
            target_file=$(echo "$source_file" | sed "s|docs/$source_lang/|docs/$target_lang/|")
            
            # Create target directory if it doesn't exist
            mkdir -p "$(dirname "$target_file")"
            
            echo "Translating $source_file ($source_lang) -> $target_file ($target_lang)"
            
            # Run translation using markdown-translator CLI
            # The tool translates from English to other languages
            cd markdown-translator
            if node bin/cli.js translate \
              -i "../$source_file" \
              -l "$target_lang" \
              -o "../$target_file"; then
              translation_count=$((translation_count + 1))
              echo "✓ Successfully translated to $target_file"
            else
              failed_count=$((failed_count + 1))
              echo "✗ Failed to translate to $target_file"
            fi
            cd "$GITHUB_WORKSPACE"
          done < missing_translations.txt
          
          echo "translation_count=$translation_count" >> $GITHUB_OUTPUT
          echo "failed_count=$failed_count" >> $GITHUB_OUTPUT
          
          if [ $translation_count -eq 0 ]; then
            echo "success=false" >> $GITHUB_OUTPUT
          else
            echo "success=true" >> $GITHUB_OUTPUT
          fi

      - name: Configure git
        if: steps.check-permission.outputs.is_maintainer == 'true' && steps.translate.outputs.success == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push translations
        if: steps.check-permission.outputs.is_maintainer == 'true' && steps.translate.outputs.success == 'true'
        id: push
        run: |
          # Add translated files
          git add docs/en/ docs/zh/ docs/ja/
          
          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "No changes to commit"
            echo "pushed=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Commit changes
          git commit -m "chore: add automated translations

          Generated by markdown-translator
          Triggered by: @${{ github.event.comment.user.login }}"
          
          # Push to PR branch
          # For fork PRs, this requires a PAT with appropriate permissions
          if [ "${{ steps.pr-details.outputs.is_fork }}" == "true" ]; then
            echo "⚠️ Cannot push directly to fork. Translations need to be submitted via separate PR."
            echo "pushed=false" >> $GITHUB_OUTPUT
            
            # Create a patch file instead
            git format-patch -1 HEAD --stdout > translations.patch
            echo "Created translations.patch"
          else
            git push origin ${{ steps.pr-details.outputs.head_ref }}
            echo "pushed=true" >> $GITHUB_OUTPUT
          fi

      - name: Add translations_added label
        if: steps.check-permission.outputs.is_maintainer == 'true' && steps.push.outputs.pushed == 'true'
        run: |
          gh pr edit ${{ github.event.issue.number }} --add-label "translations_added"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on success
        if: steps.check-permission.outputs.is_maintainer == 'true' && steps.push.outputs.pushed == 'true'
        run: |
          gh pr comment ${{ github.event.issue.number }} --body \
            "✅ Successfully generated and pushed ${{ steps.translate.outputs.translation_count }} translation(s).
            
            The \`translations_added\` label has been added to this PR."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload patch for fork PRs
        if: |
          steps.check-permission.outputs.is_maintainer == 'true' && 
          steps.translate.outputs.success == 'true' && 
          steps.pr-details.outputs.is_fork == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: translations-patch
          path: translations.patch

      - name: Comment on fork PR
        if: |
          steps.check-permission.outputs.is_maintainer == 'true' && 
          steps.translate.outputs.success == 'true' && 
          steps.pr-details.outputs.is_fork == 'true'
        run: |
          gh pr comment ${{ github.event.issue.number }} --body \
            "✅ Successfully generated ${{ steps.translate.outputs.translation_count }} translation(s).
            
            ⚠️ Since this is a fork PR, the translations cannot be pushed directly. Please download the patch file from the workflow artifacts and apply it to your branch:
            
            \`\`\`bash
            # Download translations.patch from workflow artifacts
            git apply translations.patch
            git add .
            git commit -m 'chore: apply automated translations'
            git push
            \`\`\`"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment when no files selected
        if: |
          steps.check-permission.outputs.is_maintainer == 'true' && 
          steps.get-files.outputs.has_files == 'false'
        run: |
          gh pr comment ${{ github.event.issue.number }} --body \
            "⚠️ No translations selected. Please check the boxes in the translation comment for the files you want to translate, then run \`/translate\` again."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on failure
        if: |
          steps.check-permission.outputs.is_maintainer == 'true' && 
          steps.translate.outputs.success == 'false'
        run: |
          gh pr comment ${{ github.event.issue.number }} --body \
            "❌ Translation failed. Please check the workflow logs for details."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on permission denied
        if: steps.check-permission.outputs.is_maintainer == 'false'
        run: |
          gh pr comment ${{ github.event.issue.number }} --body \
            "⚠️ Only members of the \`docs-maintainer\` team can trigger automatic translations."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
