name: Translation Runner
on:
  issue_comment:
    types: [created]

jobs:
  execute:
    if: github.event.issue.pull_request && startsWith(github.event.comment.body, '/translate')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Check Team Membership
        uses: actions/github-script@v7
        with:
          script: |
            const user = context.payload.comment.user.login;
            try {
              await github.rest.teams.getMembershipForUserInOrg({
                org: 'StarRocks',
                team_slug: 'docs-maintainer',
                username: user,
              });
            } catch (error) {
              core.setFailed(`User ${user} is not authorized.`);
            }

      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: refs/pull/${{ github.event.issue.number }}/head

      - name: Get Checkbox State
        id: get_checks
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number,
            });
            const report = comments.find(c => c.body.includes('### ðŸŒŽ Translation Required?'));
            return report ? report.body : '';

      - name: Get Changed Files
        id: changed-files
        uses: tj-actions/changed-files@v44

      - name: Run Translations
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          BODY: ${{ steps.get_checks.outputs.result }}
          FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          pip install -U google-genai pyyaml
          for FILE in $FILES; do
            SRC=$(echo $FILE | cut -d'/' -f2)
            for LANG in ja zh en; do
              if [ "$SRC" == "$LANG" ]; then continue; fi
              
              # Map lang code to full label for Global Check
              FULL_LANG=$(echo $LANG | sed 's/ja/Japanese/;s/zh/Chinese/;s/en/English/')
              
              GLOBAL_STR=" [x] **$FULL_LANG ($LANG)** for **ALL** missing files"
              INDIVIDUAL_STR=" [x] **$LANG** for \`$FILE\`"
              
              if [[ "$BODY" == *"$GLOBAL_STR"* ]] || [[ "$BODY" == *"$INDIVIDUAL_STR"* ]]; then
                python docs/translation/translate.py -l $LANG --files "$FILE"
              fi
            done
          done

      - name: Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          if [[ -n $(git status --porcelain) ]]; then
            git add .
            git commit -m "docs: automated translation via Gemini [skip ci]"
            git push origin HEAD:${{ github.event.pull_request.head.ref }}
          fi
